<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DM Fotoparadies Order Tracker</title>
  <meta name="google-site-verification" content="A2-2NBIz12AvWlQSGGYc32hEZ-IrfUEy5V7ENmQ7iaE" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'media',
      theme: {
        extend: {
          colors: {
            primary: '#005eb8',
            secondary: '#f5f5f5',
            accent: '#ff6900',
            success: '#4CAF50',
            processing: '#FFC107',
            error: '#F44336'
          }
        }
      }
    }
  </script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* Custom animation for loading indicators */
    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }
    }

    .pulse {
      animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    /* Custom badge statuses */
    .status-new {
      @apply inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200;
    }

    .status-processing {
      @apply inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-yellow-400 text-gray-900 dark:bg-yellow-600 dark:text-white;
    }

    .status-shipped {
      @apply inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-500 text-white;
    }

    .status-delivered {
      @apply inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-500 text-white;
    }

    .status-loading {
      @apply inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gray-400 text-white dark:bg-gray-600 dark:text-white;
    }

    /* Transition for order cards */
    .order-card {
      transition: all 0.3s ease;
    }

    /* Glass-like backgrounds for different statuses */
    .order-card-loading {
      background: linear-gradient(135deg, rgba(156, 163, 175, 0.1), rgba(156, 163, 175, 0.05));
      backdrop-filter: blur(10px);
      border: 1px solid rgba(156, 163, 175, 0.2);
    }

    .order-card-processing {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(59, 130, 246, 0.05));
      backdrop-filter: blur(10px);
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .order-card-produced {
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(139, 92, 246, 0.05));
      backdrop-filter: blur(10px);
      border: 1px solid rgba(139, 92, 246, 0.3);
    }

    .order-card-shipped {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(99, 102, 241, 0.05));
      backdrop-filter: blur(10px);
      border: 1px solid rgba(99, 102, 241, 0.3);
    }

    .order-card-delivered {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(34, 197, 94, 0.05));
      backdrop-filter: blur(10px);
      border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .order-card-default {
      background: linear-gradient(135deg, rgba(107, 114, 128, 0.1), rgba(107, 114, 128, 0.05));
      backdrop-filter: blur(10px);
      border: 1px solid rgba(107, 114, 128, 0.2);
    }

    .order-card-collected {
      background: linear-gradient(135deg, rgba(156, 163, 175, 0.1), rgba(156, 163, 175, 0.05));
      backdrop-filter: blur(10px);
      border: 1px solid rgba(156, 163, 175, 0.2);
      opacity: 0.7;
    }

    /* Styling for the delivery address */
    .delivery-address {
      white-space: pre-line;
    }

    /* Collapsible collected orders section */
    .collected-section-header {
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .collected-section-header:hover {
      background: linear-gradient(135deg, rgba(156, 163, 175, 0.15), rgba(156, 163, 175, 0.08));
    }

    .collected-orders-container {
      transition: all 0.3s ease;
      overflow: hidden;
    }

    .collected-orders-container.collapsed {
      max-height: 0;
      opacity: 0;
      margin-top: 0;
    }

    .collected-orders-container:not(.collapsed) {
      max-height: none;
      opacity: 1;
    }

  </style>
</head>

<body class="bg-gray-50 dark:bg-gray-900 min-h-screen transition-colors duration-300">
  <header class="bg-primary text-white shadow-lg">
    <div class="container mx-auto px-4 py-6">
      <div class="flex justify-between items-center">
        <h1 class="text-2xl font-bold flex items-center">
          <i class="fas fa-camera-retro mr-3"></i>
          DM Fotoparadies Order Tracker
        </h1>
        <div class="text-sm opacity-75">Your Photos, Your Memories</div>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8">
    <!-- Add Order Form -->
    <section class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 mb-8 transition-colors duration-300">
      <h2 class="text-xl font-semibold mb-4 flex items-center text-gray-900 dark:text-white">
        <i class="fas fa-plus-circle mr-2 text-success"></i>
        Add New Order
      </h2>

      <form id="add-order-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label for="shop-number" class="block mb-1 font-medium text-gray-700 dark:text-gray-300">
            <i class="fas fa-store mr-1 text-primary"></i>
            Shop/Filiale Number
          </label>
          <input type="text" id="shop-number" placeholder="e.g., 1234" required class="w-full p-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-colors duration-300">
        </div>

        <div>
          <label for="order-number" class="block mb-1 font-medium text-gray-700 dark:text-gray-300">
            <i class="fas fa-hashtag mr-1 text-primary"></i>
            Order Number
          </label>
          <input type="text" id="order-number" placeholder="e.g., 123456" required class="w-full p-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-colors duration-300">
        </div>

        <div class="flex items-end">
          <button type="submit" class="w-full bg-primary hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-all flex items-center justify-center">
            <i class="fas fa-plus mr-2"></i>
            Track Order
          </button>
        </div>
      </form>
    </section>

    <!-- Controls & Information -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
      <div class="flex items-center mb-4 sm:mb-0">
        <h2 class="text-xl font-semibold flex items-center text-gray-900 dark:text-white">
          <i class="fas fa-history mr-2 text-primary"></i>
          Your Orders
        </h2>
        <span id="order-count" class="ml-2 text-xs bg-gray-200 dark:bg-gray-700 dark:text-gray-300 rounded-full px-2 py-1 font-medium transition-colors duration-300">0 orders</span>
      </div>

      <div class="flex flex-wrap gap-2">
        <label class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 dark:text-gray-200 px-4 py-2 rounded-lg text-sm font-medium flex items-center transition-colors duration-300 cursor-pointer">
          <input type="checkbox" id="url-sync-toggle" class="mr-2">
          <i class="fas fa-link mr-1"></i>
          URL Sync
        </label>
        <button id="refresh-all-btn" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 dark:text-gray-200 px-4 py-2 rounded-lg text-sm font-medium flex items-center transition-colors duration-300">
          <i class="fas fa-sync-alt mr-1"></i>
          Refresh All
        </button>
        <button id="clear-all-btn" class="bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 border border-gray-300 dark:border-gray-600 dark:text-gray-200 px-4 py-2 rounded-lg text-sm font-medium flex items-center transition-colors duration-300">
          <i class="fas fa-trash-alt mr-1"></i>
          Clear All
        </button>
      </div>
    </div>

    <!-- Order List -->
    <div id="orders-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
      <!-- Placeholder when no orders exist -->
      <div id="no-orders-placeholder" class="col-span-full bg-white dark:bg-gray-800 rounded-xl shadow-md p-10 text-center transition-colors duration-300">
        <div class="mb-4 text-6xl text-gray-300 dark:text-gray-600">
          <i class="fas fa-box-open"></i>
        </div>
        <h3 class="text-xl font-semibold text-gray-500 dark:text-gray-400 mb-2">No orders tracked yet</h3>
        <p class="text-gray-500 dark:text-gray-400 mb-4">Add your DM Fotoparadies order information to track its status</p>
        <button id="scroll-to-form-btn" class="inline-flex items-center bg-primary hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg">
          <i class="fas fa-plus mr-2"></i>
          Add Your First Order
        </button>
      </div>
    </div>
  </main>

  <footer class="bg-white dark:bg-gray-800 border-t dark:border-gray-700 py-8 mt-12 transition-colors duration-300">
    <div class="container mx-auto px-4 text-center text-gray-600 dark:text-gray-400 text-sm">
      <p>
        <a href="https://github.com/simon300000/fotoparadies-order-status" target="_blank" rel="noopener noreferrer" class="text-gray-600 dark:text-gray-400 hover:text-primary transition-colors">
          <i class="fab fa-github"></i>
        </a>
      </p>
    </div>
  </footer>

  <!-- Confirmation Modal -->
  <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full transition-colors duration-300">
      <div class="p-6">
        <div class="text-lg font-semibold flex items-center mb-4 text-gray-900 dark:text-white">
          <i class="fas fa-exclamation-circle text-error mr-2"></i>
          Confirm Action
        </div>
        <p id="confirmation-message" class="mb-6 text-gray-700 dark:text-gray-300">
          Are you sure you want to delete all orders? This action cannot be undone.
        </p>
        <div class="flex justify-end space-x-3">
          <button id="cancel-btn" class="px-4 py-2 rounded-lg text-sm font-medium text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-300">
            Cancel
          </button>
          <button id="confirm-btn" class="px-4 py-2 rounded-lg text-sm font-medium bg-error text-white hover:bg-red-700">
            Confirm
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize order tracking
      orderTracker.init()
    })

    // Order Tracker Module
    const orderTracker = (() => {
      // Constants
      const STORAGE_KEY = 'dmfoto_orders'
      const API_BASE_URL = 'https://spot.photoprintit.com/spotapi/orderInfo/forShop'
      const CONFIG_ID = '1320'
      const FOUR_HOURS = 4 * 60 * 60 * 1000
      const ACTIVE_HOURS = { start: 7, end: 22 }

      // Status configuration - centralized for easy maintenance
      const STATUS_CONFIG = {
        LOADING: {
          class: 'status-loading',
          icon: 'fa-spinner fa-spin',
          text: 'Loading...',
          cardClass: 'order-card-loading'
        },
        PROCESSING: {
          class: 'status-processing',
          icon: 'fa-cog fa-spin',
          text: 'Processing',
          cardClass: 'order-card-processing'
        },
        PRODUCED: {
          class: 'status-produced',
          icon: 'fa-check',
          text: 'Produced',
          cardClass: 'order-card-produced'
        },
        SHIPPED: {
          class: 'status-shipped',
          icon: 'fa-truck',
          text: 'Shipped',
          cardClass: 'order-card-shipped'
        },
        DELIVERED: {
          class: 'status-delivered',
          icon: 'fa-check-double',
          text: 'Delivered',
          cardClass: 'order-card-delivered'
        },
        COLLECTED: {
          class: 'status-collected',
          icon: 'fa-check-circle',
          text: 'Collected',
          cardClass: 'order-card-collected'
        }
      }

      // DOM elements cache
      const elements = {
        form: document.getElementById('add-order-form'),
        ordersContainer: document.getElementById('orders-container'),
        noOrdersPlaceholder: document.getElementById('no-orders-placeholder'),
        orderCount: document.getElementById('order-count'),
        shopNumberInput: document.getElementById('shop-number'),
        orderNumberInput: document.getElementById('order-number'),
        refreshAllBtn: document.getElementById('refresh-all-btn'),
        clearAllBtn: document.getElementById('clear-all-btn'),
        scrollToFormBtn: document.getElementById('scroll-to-form-btn'),
        confirmationModal: document.getElementById('confirmation-modal'),
        confirmBtn: document.getElementById('confirm-btn'),
        cancelBtn: document.getElementById('cancel-btn'),
        confirmationMessage: document.getElementById('confirmation-message'),
        urlSyncToggle: document.getElementById('url-sync-toggle')
      }

      // Utility functions
      const showError = (message) => alert(`Error: ${message}`)
      
      const loadOrders = () => {
        const ordersJSON = localStorage.getItem(STORAGE_KEY)
        return ordersJSON ? JSON.parse(ordersJSON) : []
      }

      const saveOrders = (orders) => {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(orders))
        updateURL(orders)
      }

      // URL Sync Functions
      const isUrlSyncEnabled = () => {
        const enabled = localStorage.getItem('urlSyncEnabled')
        return enabled === 'true' // Default to false
      }

      const setUrlSyncEnabled = (enabled) => {
        localStorage.setItem('urlSyncEnabled', enabled.toString())
        if (enabled) {
          // If enabling, first import orders from URL, then update URL
          const hash = window.location.hash
          if (hash && hash.includes('orders=')) {
            // Import orders from URL first
            try {
              const encoded = hash.split('orders=')[1]
              const jsonStr = atob(encoded)
              const urlOrders = JSON.parse(jsonStr)

              const existingOrders = loadOrders()
              let hasNewOrders = false

              // Add orders from URL that don't already exist
              urlOrders.forEach(urlOrder => {
                const exists = existingOrders.some(order =>
                  order.shopNumber === urlOrder.s && order.orderNumber === urlOrder.o
                )

                if (!exists) {
                  const newOrder = {
                    shopNumber: urlOrder.s,
                    orderNumber: urlOrder.o,
                    createdAt: Date.now(),
                    lastUpdated: 0,
                    data: null,
                    status: 'LOADING',
                    isLoading: true,
                    collected: false,
                    collectionDate: null
                  }
                  existingOrders.unshift(newOrder)
                  hasNewOrders = true

                  // Fetch order status
                  processOrder(urlOrder.s, urlOrder.o)
                }
              })

              if (hasNewOrders) {
                // Save will trigger updateURL automatically
                saveOrders(existingOrders)
                renderOrders(existingOrders)
              } else {
                // No new orders, just update URL with current orders
                const orders = loadOrders()
                updateURL(orders)
              }
            } catch (error) {
              console.error('Failed to load orders from URL:', error)
              // Still update URL even if import failed
              const orders = loadOrders()
              updateURL(orders)
            }
          } else {
            // No orders in URL, just update URL with current orders
            const orders = loadOrders()
            updateURL(orders)
          }
        } else {
          // If disabling, clear URL hash
          if (window.location.hash) {
            history.replaceState(null, '', window.location.pathname + window.location.search)
          }
        }
      }

      const updateURL = (orders) => {
        // Only update URL if sync is enabled
        if (!isUrlSyncEnabled()) {
          return
        }

        // Get the latest 10 non-collected orders
        const latest10 = orders
          .filter(order => !order.collected)
          .slice(0, 10)
          .map(order => ({
            s: order.shopNumber,
            o: order.orderNumber
          }))

        if (latest10.length === 0) {
          // Clear URL hash if no orders
          if (window.location.hash) {
            history.replaceState(null, '', window.location.pathname + window.location.search)
          }
          return
        }

        try {
          const jsonStr = JSON.stringify(latest10)
          const encoded = btoa(jsonStr)
          history.replaceState(null, '', `#orders=${encoded}`)
        } catch (error) {
          console.error('Failed to update URL:', error)
        }
      }

      const loadOrdersFromURL = () => {
        // Only load from URL if sync is enabled
        if (!isUrlSyncEnabled()) {
          return
        }

        const hash = window.location.hash
        if (!hash || !hash.includes('orders=')) {
          return
        }

        try {
          const encoded = hash.split('orders=')[1]
          const jsonStr = atob(encoded)
          const urlOrders = JSON.parse(jsonStr)

          const existingOrders = loadOrders()
          let hasNewOrders = false

          // Add orders from URL that don't already exist
          urlOrders.forEach(urlOrder => {
            const exists = existingOrders.some(order =>
              order.shopNumber === urlOrder.s && order.orderNumber === urlOrder.o
            )

            if (!exists) {
              const newOrder = {
                shopNumber: urlOrder.s,
                orderNumber: urlOrder.o,
                createdAt: Date.now(),
                lastUpdated: 0,
                data: null,
                status: 'LOADING',
                isLoading: true,
                collected: false,
                collectionDate: null
              }
              existingOrders.push(newOrder)
              hasNewOrders = true

              // Fetch order status
              processOrder(urlOrder.s, urlOrder.o)
            }
          })

          if (hasNewOrders) {
            saveOrders(existingOrders)
            renderOrders(existingOrders)
          }
        } catch (error) {
          console.error('Failed to load orders from URL:', error)
        }
      }

      const loadSavedShopNumber = () => {
        const savedShopNumber = localStorage.getItem('lastShopNumber')
        if (savedShopNumber) {
          elements.shopNumberInput.value = savedShopNumber
        }
      }

      const saveShopNumber = (shopNumber) => {
        localStorage.setItem('lastShopNumber', shopNumber)
      }

      // Status mapping functions - now using centralized config
      const mapApiStatusToAppStatus = (apiStatus) => {
        if (apiStatus === 'DELIVERED') return 'DELIVERED'
        if (apiStatus === 'SHIPPED') return 'SHIPPED'
        if (apiStatus === 'PRODUCED') return 'PRODUCED'
        return 'PROCESSING'
      }

      const getStatusBadge = (status) => {
        const config = STATUS_CONFIG[status] || STATUS_CONFIG.LOADING

        // Use direct Tailwind classes instead of CSS @apply
        let badgeClasses = 'inline-flex items-center px-3 py-1 rounded-full text-xs font-medium '

        switch(status) {
          case 'LOADING':
            badgeClasses += 'bg-gray-400 text-white dark:bg-gray-600 dark:text-white'
            break
          case 'PROCESSING':
            badgeClasses += 'bg-blue-500 text-white'
            break
          case 'PRODUCED':
            badgeClasses += 'bg-violet-500 text-white'
            break
          case 'SHIPPED':
            badgeClasses += 'bg-indigo-500 text-white'
            break
          case 'DELIVERED':
            badgeClasses += 'bg-green-500 text-white'
            break
          case 'COLLECTED':
            badgeClasses += 'bg-gray-500 text-white'
            break
          default:
            badgeClasses += 'bg-gray-400 text-white dark:bg-gray-600 dark:text-white'
        }

        return `<span class="${badgeClasses}"><i class="fas ${config.icon} mr-1"></i> ${config.text}</span>`
      }

      const getCardClass = (status, summaryStateCode, collected) => {
        if (collected) return 'order-card-collected'
        const statusToCheck = summaryStateCode || status
        const config = STATUS_CONFIG[statusToCheck] || STATUS_CONFIG
        return config.cardClass || 'order-card-default'
      }

      // API and Order Management
      const fetchOrderStatus = async (shopNumber, orderNumber) => {
        const url = `${API_BASE_URL}?config=${CONFIG_ID}&shop=${shopNumber}&order=${orderNumber}`

        try {
          const response = await fetch(url)

          if (!response.ok) {
            throw new Error(`Server responded with status: ${response.status}`)
          }

          const data = await response.json()

          if (!data || !data.summaryStateText) {
            throw new Error("Invalid order data received")
          }

          return data
        } catch (error) {
          throw new Error("Failed to fetch order information. Please check your numbers and try again.")
        }
      }

      const updateOrderStatus = (shopNumber, orderNumber, data = null, error = null) => {
        const orders = loadOrders()
        const orderIndex = orders.findIndex(order =>
          order.shopNumber === shopNumber && order.orderNumber === orderNumber
        )

        if (orderIndex === -1) return

        const updates = {
          isLoading: false,
          lastUpdated: Date.now()
        }

        if (error) {
          updates.status = 'LOADING'
          updates.errorMessage = error
        } else if (data) {
          updates.data = data
          updates.status = mapApiStatusToAppStatus(data.summaryStateCode)
          delete updates.errorMessage
        }

        orders[orderIndex] = { ...orders[orderIndex], ...updates }
        saveOrders(orders)
        renderOrders(orders)
      }

      const processOrder = async (shopNumber, orderNumber) => {
        try {
          const data = await fetchOrderStatus(shopNumber, orderNumber)
          updateOrderStatus(shopNumber, orderNumber, data)
        } catch (error) {
          console.error('Error processing order:', error)
          updateOrderStatus(shopNumber, orderNumber, null, error.message || "Could not load order information")
        }
      }

      // Initialize the tracker
      const init = () => {
        // First load any orders from URL
        loadOrdersFromURL()

        const orders = loadOrders()
        renderOrders(orders)
        loadSavedShopNumber()

        // Initialize URL sync toggle state
        elements.urlSyncToggle.checked = isUrlSyncEnabled()

        setupEventListeners()
        startSmartAutoRefresh()
      }

      // Setup all event listeners
      const setupEventListeners = () => {
        elements.form.addEventListener('submit', handleAddOrder)
        elements.refreshAllBtn.addEventListener('click', refreshAllOrders)
        elements.clearAllBtn.addEventListener('click', showClearConfirmation)
        elements.scrollToFormBtn.addEventListener('click', scrollToForm)
        elements.confirmBtn.addEventListener('click', handleClearOrders)
        elements.cancelBtn.addEventListener('click', hideConfirmationModal)
        elements.urlSyncToggle.addEventListener('change', handleUrlSyncToggle)
      }

      const handleUrlSyncToggle = (e) => {
        setUrlSyncEnabled(e.target.checked)
      }

      // Event handlers
      const handleAddOrder = (e) => {
        e.preventDefault()

        const shopNumber = elements.shopNumberInput.value.trim()
        const orderNumber = elements.orderNumberInput.value.trim()

        if (!shopNumber || !orderNumber) {
          showError("Please enter both shop and order numbers")
          return
        }

        const orders = loadOrders()
        const exists = orders.some(order =>
          order.shopNumber === shopNumber && order.orderNumber === orderNumber
        )

        if (exists) {
          showError("This order is already being tracked")
          return
        }

        saveShopNumber(shopNumber)

        // Create new order
        const newOrder = {
          shopNumber,
          orderNumber,
          createdAt: Date.now(),
          lastUpdated: 0,
          data: null,
          status: 'LOADING',
          isLoading: true,
          collected: false,
          collectionDate: null
        }

        orders.unshift(newOrder)
        saveOrders(orders)
        renderOrders(orders)

        // Fetch order status
        processOrder(shopNumber, orderNumber)
      }

      const refreshOrder = (shopNumber, orderNumber) => {
        const orders = loadOrders()
        const orderIndex = orders.findIndex(order =>
          order.shopNumber === shopNumber && order.orderNumber === orderNumber
        )

        if (orderIndex !== -1) {
          orders[orderIndex].isLoading = true
          saveOrders(orders)
          renderOrders(orders)
        }

        processOrder(shopNumber, orderNumber)
      }

      const refreshAllOrders = () => {
        const orders = loadOrders()
        orders.forEach(order => refreshOrder(order.shopNumber, order.orderNumber))

        // Visual feedback
        const refreshBtn = elements.refreshAllBtn
        const originalHTML = refreshBtn.innerHTML
        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Refreshing...'

        setTimeout(() => {
          refreshBtn.innerHTML = originalHTML
        }, 2000)
      }

      const handleRemoveOrder = (shopNumber, orderNumber) => {
        const orders = loadOrders()
        const updatedOrders = orders.filter(order =>
          !(order.shopNumber === shopNumber && order.orderNumber === orderNumber)
        )
        saveOrders(updatedOrders)
        renderOrders(updatedOrders)
      }

      const handleClearOrders = () => {
        saveOrders([])
        renderOrders([])
        hideConfirmationModal()
      }

      const showClearConfirmation = () => {
        const orders = loadOrders()

        if (orders.length === 0) {
          showError("There are no orders to clear")
          return
        }

        elements.confirmationMessage.textContent =
          `Are you sure you want to delete all ${orders.length} orders? This action cannot be undone.`

        elements.confirmationModal.classList.remove('hidden')
      }

      const hideConfirmationModal = () => {
        elements.confirmationModal.classList.add('hidden')
      }

      const scrollToForm = () => {
        elements.form.scrollIntoView({
          behavior: 'smooth',
          block: 'center'
        })

        const formContainer = elements.form.parentElement
        formContainer.classList.add('ring-2', 'ring-primary')

        setTimeout(() => {
          formContainer.classList.remove('ring-2', 'ring-primary')
        }, 1500)
      }

      // Render all orders in UI
      const renderOrders = (orders) => {
        saveOrders(orders)

        // Separate active and collected orders
        const activeOrders = orders.filter(order => !order.collected)
        const collectedOrders = orders.filter(order => order.collected)

        // Update order count
        elements.orderCount.textContent = `${orders.length} ${orders.length === 1 ? 'order' : 'orders'}`

        // Toggle placeholder visibility
        elements.noOrdersPlaceholder.classList.toggle('hidden', orders.length > 0)

        // Generate HTML for active orders
        const activeOrdersHTML = activeOrders.map(createOrderCard).join('')

        // Generate HTML for collected orders section
        let collectedSectionHTML = ''
        if (collectedOrders.length > 0) {
          const collectedOrdersHTML = collectedOrders.map(createOrderCard).join('')
          const isCollapsed = localStorage.getItem('collectedOrdersCollapsed') === 'true'

          collectedSectionHTML = `
            <div class="col-span-full">
              <div class="collected-section-header bg-white dark:bg-gray-800 rounded-xl shadow-md p-4 mb-4 transition-colors duration-300"
                   onclick="orderTracker.toggleCollectedOrders()">
                <div class="flex items-center justify-between">
                  <div class="flex items-center">
                    <i class="fas fa-check-circle text-gray-500 mr-3"></i>
                    <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300">
                      Collected Orders (${collectedOrders.length})
                    </h3>
                  </div>
                  <i class="fas fa-chevron-${isCollapsed ? 'down' : 'up'} text-gray-500 transition-transform duration-300"></i>
                </div>
              </div>
              <div class="collected-orders-container grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 ${isCollapsed ? 'collapsed' : ''}">
                ${collectedOrdersHTML}
              </div>
            </div>
          `
        }

        // Combine active orders and collected section
        elements.ordersContainer.innerHTML = activeOrdersHTML + collectedSectionHTML

        // Attach event listeners
        attachOrderEventListeners()
      }

      const attachOrderEventListeners = () => {
        document.querySelectorAll('.remove-order-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const shop = this.getAttribute('data-shop')
            const orderNumber = this.getAttribute('data-order')
            handleRemoveOrder(shop, orderNumber)
          })
        })

        document.querySelectorAll('.refresh-order-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const shop = this.getAttribute('data-shop')
            const orderNumber = this.getAttribute('data-order')
            refreshOrder(shop, orderNumber)
          })
        })

        document.querySelectorAll('.collected-checkbox').forEach(checkbox => {
          checkbox.addEventListener('change', function() {
            const shop = this.getAttribute('data-shop')
            const orderNumber = this.getAttribute('data-order')
            toggleCollectedStatus(shop, orderNumber, this.checked)
          })
        })
      }

      // Create subOrders section HTML
      const createSubOrdersSection = (subOrders) => {
        if (!subOrders || subOrders.length === 0) return ''
        
        // Check if any subOrder has positions with items
        const hasItems = subOrders.some(subOrder => 
          subOrder.positions && subOrder.positions.length > 0
        )
        
        // If no items exist, don't show Order Details section at all
        if (!hasItems) return ''
        
        const subOrdersHTML = subOrders.map(subOrder => {
          const positionsHTML = subOrder.positions && subOrder.positions.length > 0 ?
            subOrder.positions.map(position => `
              <div class="flex justify-between items-start py-1">
                <span class="text-sm text-gray-700 dark:text-gray-300 flex-1">${position.description || 'Item'}</span>
                <span class="text-sm font-medium text-gray-900 dark:text-white ml-2">${position.quantity || 1}x</span>
              </div>
            `).join('') : ''
          
          return positionsHTML ? `
            <div class="bg-white/20 dark:bg-gray-700/20 backdrop-blur-sm rounded-lg p-3 mb-2">
              <div class="space-y-0.5">
                ${positionsHTML}
              </div>
            </div>
          ` : ''
        }).join('')
        
        return `
          <div class="mt-3 pt-3 border-t border-white/30 dark:border-gray-600/30">
            <div class="flex items-center gap-2 mb-2">
              <i class="fas fa-list-ul text-gray-600 dark:text-gray-400"></i>
              <span class="font-medium text-sm text-gray-700 dark:text-gray-300">Order Details</span>
            </div>
            ${subOrdersHTML}
          </div>
        `
      }

      // Create an order card for the UI
      const createOrderCard = (order) => {
        // Get status information
        let statusText = "Loading order information..."
        let statusBadge = getStatusBadge(order.collected ? 'COLLECTED' : order.status)
        let cardClass = getCardClass(order.status, null, order.collected)

        if (order.data) {
          statusText = order.data.summaryStateText || "Status information available"
          statusBadge = getStatusBadge(order.collected ? 'COLLECTED' : (order.data.summaryStateCode || order.status))
          cardClass = getCardClass(order.status, order.data.summaryStateCode, order.collected)
        } else if (order.errorMessage) {
          statusText = order.errorMessage || "Failed to load order information"
        }

        const lastUpdated = order.lastUpdated ?
          new Date(order.lastUpdated).toLocaleString() :
          'Not updated yet'

        const orderDateSection = order.data?.orderDate ? `
          <div class="text-sm text-gray-600 dark:text-gray-300 mb-2">
            Order: ${new Date(order.data.orderDate).toLocaleDateString()}
          </div>` : ''

        const collectionDateSection = order.collected && order.collectionDate ? `
          <div class="text-sm text-gray-600 dark:text-gray-300 mb-2">
            Collected: ${new Date(order.collectionDate).toLocaleDateString()}
          </div>` : ''

        const deliverySection = order.data?.deliveryText ? `
          <div class="flex items-start gap-2 mb-3">
            <i class="fas fa-map-marker-alt text-accent mt-0.5"></i>
            <div class="flex-1">
              <span class="font-medium text-sm text-gray-900 dark:text-white">Delivery:</span>
              <div class="delivery-address bg-white/30 dark:bg-gray-700/30 backdrop-blur-sm p-2 rounded mt-1 text-sm whitespace-pre-line text-gray-700 dark:text-gray-300">${order.data.deliveryText}</div>
            </div>
          </div>` : ''

        const priceSection = (order.data?.summaryPrice || order.data?.summaryPriceText) ? `
          <div class="flex items-start gap-2 mb-3">
            <i class="fas fa-euro-sign text-success mt-0.5"></i>
            <div class="flex-1">
              <span class="font-medium text-sm text-gray-900 dark:text-white">Price:</span>
              <div class="text-sm text-gray-700 dark:text-gray-300 mt-1">
                ${order.data.summaryPriceText || order.data.summaryPrice || ''}
              </div>
            </div>
          </div>` : ''

        const refreshButtonContent = order.isLoading ?
          '<i class="fas fa-spinner fa-spin mr-1"></i> Refreshing...' :
          '<i class="fas fa-redo mr-1"></i> Refresh'

        const officialStatusUrl = `https://www.fotoparadies.de/service/auftragsstatus.html#/?orderid=${order.orderNumber}&locationid=${order.shopNumber}`

        return `
          <div class="order-card ${cardClass} rounded-xl shadow-lg overflow-hidden h-fit">
            <div class="p-4 border-b border-white/20 dark:border-gray-600/20">
              <div class="flex flex-col gap-2">
                <div class="flex-1 min-w-0">
                  <h3 class="text-lg font-semibold truncate text-gray-900 dark:text-white">#${order.orderNumber}</h3>
                  <div class="text-sm text-gray-600 dark:text-gray-300 mb-2">Shop: ${order.shopNumber}</div>
                  <div class="text-sm text-gray-600 dark:text-gray-300 mb-2">Added: ${new Date(order.createdAt || 0).toLocaleDateString()}</div>
                  ${orderDateSection}
                  ${collectionDateSection}
                </div>
                <div class="flex-shrink-0">${statusBadge}</div>
              </div>
            </div>
            
            <div class="p-4">
              <div class="flex items-start gap-2 mb-3">
                <i class="fas fa-info-circle text-primary mt-0.5"></i>
                <div class="flex-1">
                  <span class="font-medium text-sm text-gray-900 dark:text-white">Status:</span>
                  <div class="text-sm text-gray-700 dark:text-gray-300 mt-1">${statusText}</div>
                </div>
              </div>
              
              ${deliverySection}
              ${priceSection}
              
              ${order.data?.subOrders ? createSubOrdersSection(order.data.subOrders) : ''}
              
              <div class="flex flex-col gap-2 text-sm text-gray-600 dark:text-gray-300 pt-2 border-t border-white/20 dark:border-gray-600/20">
                <div class="flex items-center">
                  <i class="fas fa-sync-alt mr-1"></i>
                  <span class="truncate">${lastUpdated}</span>
                </div>
                <div class="flex justify-between items-center">
                  <div class="flex items-center gap-3">
                    <button
                      class="refresh-order-btn flex items-center text-sm ${order.isLoading ? 'opacity-50 cursor-not-allowed' : 'hover:text-primary'}"
                      data-shop="${order.shopNumber}"
                      data-order="${order.orderNumber}"
                      ${order.isLoading ? 'disabled' : ''}
                    >
                      ${refreshButtonContent}
                    </button>
                    <a
                      href="${officialStatusUrl}"
                      target="_blank"
                      rel="noopener noreferrer"
                      class="flex items-center text-sm text-gray-500 dark:text-gray-400 hover:text-primary"
                      title="View on official Fotoparadies status page"
                    >
                      <i class="fas fa-external-link-alt mr-1"></i>
                      Official
                    </a>
                  </div>
                  <div class="flex items-center gap-2">
                    <label class="flex items-center cursor-pointer">
                      <input
                        type="checkbox"
                        class="collected-checkbox mr-1"
                        data-shop="${order.shopNumber}"
                        data-order="${order.orderNumber}"
                        ${order.collected ? 'checked' : ''}
                      >
                      <span class="text-xs text-gray-600 dark:text-gray-400">Collected</span>
                    </label>
                    <button
                      class="remove-order-btn text-gray-500 dark:text-gray-400 hover:text-error"
                      data-shop="${order.shopNumber}"
                      data-order="${order.orderNumber}"
                    >
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>`
      }

      // Smart auto-refresh: immediately on load, then every 1 hour, only refreshing orders older than 4 hours
      const startSmartAutoRefresh = () => {
        const smartRefreshOrders = () => {
          const now = new Date()
          console.log('Auto-refresh triggered at', now.toLocaleTimeString())
          
          // Only refresh orders that haven't been updated in the last 4 hours and are not delivered
          const orders = loadOrders()
          const ordersToRefresh = orders.filter(order => {
            const timeSinceLastUpdate = Date.now() - (order.lastUpdated || 0)
            return timeSinceLastUpdate > FOUR_HOURS && order.status !== 'DELIVERED' && !order.collected
          })
          
          if (ordersToRefresh.length > 0) {
            console.log(`Refreshing ${ordersToRefresh.length} orders that are older than 4 hours (skipping delivered and collected orders)`)
            ordersToRefresh.forEach(order => {
              refreshOrder(order.shopNumber, order.orderNumber)
            })
          } else {
            console.log('No orders need refreshing (all updated within last 4 hours, delivered, or collected)')
          }
        }

        // Trigger immediate refresh on page load
        console.log('Triggering immediate refresh on page load')
        smartRefreshOrders()
        
        // Then repeat every 1 hour
        setInterval(smartRefreshOrders, 60 * 60 * 1000) // 1 hour in milliseconds
      }

      const toggleCollectedStatus = (shopNumber, orderNumber, collected) => {
        const orders = loadOrders()
        const orderIndex = orders.findIndex(order =>
          order.shopNumber === shopNumber && order.orderNumber === orderNumber
        )

        if (orderIndex !== -1) {
          orders[orderIndex].collected = collected
          orders[orderIndex].collectionDate = collected ? Date.now() : null
          saveOrders(orders)
          renderOrders(orders)
        }
      }

      const toggleCollectedOrders = () => {
        const isCurrentlyCollapsed = localStorage.getItem('collectedOrdersCollapsed') === 'true'
        const newCollapsedState = !isCurrentlyCollapsed

        localStorage.setItem('collectedOrdersCollapsed', newCollapsedState.toString())

        // Update the UI
        const container = document.querySelector('.collected-orders-container')
        const chevron = document.querySelector('.collected-section-header i.fa-chevron-up, .collected-section-header i.fa-chevron-down')

        if (container) {
          container.classList.toggle('collapsed', newCollapsedState)
        }

        if (chevron) {
          chevron.className = chevron.className.replace(/fa-chevron-(up|down)/, `fa-chevron-${newCollapsedState ? 'down' : 'up'}`)
        }
      }

      // Public API
      return { init, refreshAllOrders, toggleCollectedOrders }
    })()
  </script>
</body>

</html>
